<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<title>Explota-Color üåà - Juego para Ni√±os</title>
<style>
  :root {
    --bg: #0f172a;
    --gap: 8px;
    --radius: 16px;

    /* Colores vibrantes */
    --c1: #ff4d4f;
    --c2: #3b82f6;
    --c3: #22c55e;
    --c4: #f59e0b;
    --c5: #a855f7;

    --text: #e5e7eb;
    --muted: #9ca3af;
    
    /* Safe areas para iPhone */
    --safe-top: env(safe-area-inset-top);
    --safe-bottom: env(safe-area-inset-bottom);
    --safe-left: env(safe-area-inset-left);
    --safe-right: env(safe-area-inset-right);
  }

  * { 
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    user-select: none;
  }
  
  html, body { 
    height: 100%; 
    overflow: hidden;
    margin: 0;
    padding: 0;
  }
  
  body {
    background: 
      radial-gradient(circle at 20% 80%, #ff6b6b33, transparent 50%),
      radial-gradient(circle at 80% 20%, #4ecdc433, transparent 50%),
      radial-gradient(circle at 40% 40%, #ffe66d33, transparent 50%),
      linear-gradient(180deg, #667eea, #764ba2);
    background-size: 200% 200%;
    animation: gradientShift 15s ease infinite;
    color: var(--text);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    display: flex;
    flex-direction: column;
    padding: var(--safe-top) var(--safe-left) var(--safe-bottom) var(--safe-right);
  }

  @keyframes gradientShift {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
  }

  /* Header optimizado para iPhone */
  header {
    display: flex;
    flex-direction: column;
    gap: 10px;
    background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 16px;
    padding: 10px;
    margin: 10px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
  }

  .header-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .title {
    font-weight: 800;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .title .logo {
    font-size: 24px;
    animation: logoFloat 3s ease-in-out infinite;
  }

  @keyframes logoFloat {
    0%, 100% { transform: translateY(0) rotate(0deg); }
    50% { transform: translateY(-3px) rotate(5deg); }
  }

  .title span {
    font-size: 16px;
    background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #ffe66d);
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .stats {
    display: flex;
    gap: 8px;
    align-items: center;
    font-weight: 700;
  }

  .pill {
    background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05));
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.2);
    padding: 5px 10px;
    border-radius: 999px;
    color: #fff;
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 12px;
  }

  .pill-icon {
    font-size: 14px;
  }

  .controls {
    display: flex;
    gap: 6px;
    align-items: center;
    flex-wrap: wrap;
  }

  .controls select {
    padding: 8px 10px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.2);
    background: rgba(255,255,255,0.1);
    color: #fff;
    font-weight: 600;
    font-size: 12px;
    flex: 1;
    min-width: 80px;
  }

  button {
    border: 0;
    border-radius: 12px;
    padding: 8px 12px;
    font-weight: 600;
    font-size: 12px;
    color: white;
    background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05));
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
    flex: 1;
    min-width: 70px;
  }

  button:active {
    transform: scale(0.95);
  }

  .primary {
    background: linear-gradient(135deg, #667eea, #764ba2);
  }

  .warn {
    background: linear-gradient(135deg, #f093fb, #f5576c);
  }

  .success {
    background: linear-gradient(135deg, #4facfe, #00f2fe);
  }

  /* Tablero optimizado para iPhone */
  .board-wrap {
    flex: 1;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 10px;
    min-height: 0;
  }

  .board {
    --cols: 6;
    --rows: 8;
    --board-width: min(100vw - 40px, 400px);
    --board-height: min(100vh - 200px, 600px);
    --tile-size: min(
      calc((var(--board-width) - (var(--gap) * (var(--cols) - 1))) / var(--cols)),
      calc((var(--board-height) - (var(--gap) * (var(--rows) - 1))) / var(--rows)),
      70px
    );
    
    display: grid;
    grid-template-columns: repeat(var(--cols), var(--tile-size));
    grid-auto-rows: var(--tile-size);
    gap: var(--gap);
    padding: 12px;
    border-radius: 20px;
    background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.03));
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255,255,255,0.15);
    box-shadow: 0 20px 40px rgba(0,0,0,0.2);
    position: relative;
  }

  /* Fichas con mejor rendimiento */
  .tile {
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: calc(var(--tile-size) * 0.5);
    font-weight: 900;
    border-radius: var(--radius);
    box-shadow: 
      0 3px 0 rgba(0,0,0,0.2),
      0 6px 12px rgba(0,0,0,0.15);
    transform: translateZ(0);
    transition: transform 0.15s cubic-bezier(0.4, 0, 0.2, 1);
    outline: 2px solid rgba(255,255,255,0.15);
    cursor: pointer;
    will-change: transform;
    -webkit-transform: translateZ(0);
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
  }

  .tile::after {
    content: "";
    position: absolute;
    inset: 0;
    border-radius: var(--radius);
    background: linear-gradient(
      135deg,
      rgba(255,255,255,0.3) 0%,
      rgba(255,255,255,0.1) 40%,
      transparent 60%
    );
    pointer-events: none;
  }

  /* Colores de fichas */
  .c1 { background: linear-gradient(135deg, #ff6b6b, #ff4d4f); }
  .c2 { background: linear-gradient(135deg, #4ecdc4, #3b82f6); }
  .c3 { background: linear-gradient(135deg, #4ade80, #22c55e); }
  .c4 { background: linear-gradient(135deg, #ffd93d, #f59e0b); }
  .c5 { background: linear-gradient(135deg, #c77dff, #a855f7); }

  /* EFECTO DE CA√çDA MEJORADO */
  .falling {
    animation: fallDown var(--fall-duration, 0.3s) cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
    animation-delay: var(--fall-delay, 0s);
  }

  @keyframes fallDown {
    0% {
      transform: translateY(calc(var(--fall-distance, -100px) * -1));
      opacity: 0.8;
    }
    40% {
      opacity: 1;
    }
    85% {
      transform: translateY(5px);
    }
    100% {
      transform: translateY(0);
    }
  }

  /* Efecto de rebote al caer */
  .bounce-land {
    animation: bounceLand 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  }

  @keyframes bounceLand {
    0% { transform: translateY(0) scaleY(1); }
    40% { transform: translateY(0) scaleY(0.9) scaleX(1.1); }
    100% { transform: translateY(0) scaleY(1) scaleX(1); }
  }

  /* Rebote corto para taps inv√°lidos */
  @keyframes bounce {
    0% { transform: translateY(0); }
    40% { transform: translateY(-6px); }
    100% { transform: translateY(0); }
  }

  /* Ficha nueva apareciendo desde arriba */
  .new-tile {
    animation: dropIn var(--drop-duration, 0.4s) cubic-bezier(0.34, 1.56, 0.64, 1) both;
    animation-delay: var(--drop-delay, 0s);
  }

  @keyframes dropIn {
    0% {
      transform: translateY(-200%) scale(0.8) rotate(180deg);
      opacity: 0;
    }
    50% {
      transform: translateY(-50%) scale(1.1) rotate(90deg);
      opacity: 0.8;
    }
    85% {
      transform: translateY(5%) scale(1.05) rotate(5deg);
    }
    100% {
      transform: translateY(0) scale(1) rotate(0deg);
      opacity: 1;
    }
  }

  /* Fichas especiales */
  .special {
    color: #fff;
    font-size: calc(var(--tile-size) * 0.45);
  }

  .ball {
    --glow: #fff;
    box-shadow:
      0 0 0 2px rgba(255,255,255,0.3),
      0 0 20px var(--glow),
      0 0 40px var(--glow),
      0 3px 0 rgba(0,0,0,0.2);
    animation: 
      neonPulse 1s ease-in-out infinite,
      heartbeat 0.8s ease-in-out infinite;
  }

  .ball.c1 { --glow: #ff4d4f; }
  .ball.c2 { --glow: #3b82f6; }
  .ball.c3 { --glow: #22c55e; }
  .ball.c4 { --glow: #f59e0b; }
  .ball.c5 { --glow: #a855f7; }

  @keyframes neonPulse {
    0%, 100% { filter: brightness(1); }
    50% { filter: brightness(1.3); }
  }

  @keyframes heartbeat {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.08); }
  }

  /* Efectos de explosi√≥n */
  .exploding {
    animation: explode 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
  }

  @keyframes explode {
    0% {
      transform: scale(1);
      opacity: 1;
    }
    50% {
      transform: scale(1.3);
      filter: brightness(2);
    }
    100% {
      transform: scale(0);
      opacity: 0;
      filter: brightness(0);
    }
  }

  /* Part√≠culas mejoradas */
  .piece {
    position: fixed;
    width: 10px;
    height: 10px;
    border-radius: 2px;
    pointer-events: none;
    z-index: 9997;
    animation: flyAway 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
  }

  @keyframes flyAway {
    0% {
      transform: translate(0, 0) scale(1) rotate(0deg);
      opacity: 1;
    }
    100% {
      transform: translate(var(--dx), var(--dy)) scale(0) rotate(720deg);
      opacity: 0;
    }
  }

  /* Toast mejorado para iPhone */
  .toast {
    position: fixed;
    left: 50%;
    top: calc(var(--safe-top) + 20px);
    transform: translateX(-50%) translateY(-100px);
    background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85));
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    color: #1a1a1a;
    padding: 10px 16px;
    border-radius: 999px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    z-index: 9999;
    font-weight: 700;
    font-size: 14px;
    animation: toastSlide 1.5s ease forwards;
  }

  @keyframes toastSlide {
    0% {
      transform: translateX(-50%) translateY(-100px);
      opacity: 0;
    }
    20%, 80% {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
    100% {
      transform: translateX(-50%) translateY(-100px);
      opacity: 0;
    }
  }

  /* Flash de pantalla (SE MUD√ì AQU√ç DESDE JS) */
  @keyframes flash {
    0%, 100% { filter: brightness(1); }
    50% { filter: brightness(1.5); }
  }

  /* Modal optimizado */
  .modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    padding: 20px;
    animation: modalFadeIn 0.3s ease;
  }

  .modal-card {
    background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85));
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 20px;
    padding: 24px;
    text-align: center;
    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    color: #1a1a1a;
    max-width: 90%;
    animation: modalCardEntry 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  @keyframes modalCardEntry {
    from {
      transform: scale(0.5) rotate(180deg);
      opacity: 0;
    }
    to {
      transform: scale(1) rotate(0);
      opacity: 1;
    }
  }

  .modal h2 {
    margin: 0 0 10px 0;
    font-size: 24px;
    background: linear-gradient(45deg, #667eea, #764ba2, #f093fb);
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .modal .trophy {
    font-size: 48px;
    animation: trophySpin 2s ease infinite;
    margin-bottom: 12px;
  }

  @keyframes trophySpin {
    0%, 100% { transform: scale(1) rotate(0deg); }
    50% { transform: scale(1.2) rotate(360deg); }
  }

  /* Footer simplificado */
  footer {
    text-align: center;
    color: rgba(255,255,255,0.8);
    font-size: 11px;
    padding: 8px;
    margin: 0 10px 10px 10px;
    background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.1);
  }

  .hint {
    color: #4ade80;
    font-weight: 600;
  }

  /* Otros efectos */
  .shockwave {
    position: fixed;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    pointer-events: none;
    z-index: 9997;
    border: 2px solid var(--wave, #fff);
    animation: shockwaveExpand 0.8s ease-out forwards;
  }

  @keyframes shockwaveExpand {
    0% {
      transform: translate(-50%, -50%) scale(0);
      opacity: 1;
    }
    100% {
      transform: translate(-50%, -50%) scale(30);
      opacity: 0;
    }
  }

  .celebration-emoji {
    position: fixed;
    font-size: 32px;
    pointer-events: none;
    z-index: 10000;
    animation: celebrateFall 2s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
  }

  @keyframes celebrateFall {
    0% {
      transform: translateY(-50px) rotate(0deg) scale(0);
      opacity: 0;
    }
    10% {
      transform: translateY(0) rotate(180deg) scale(1.2);
      opacity: 1;
    }
    100% {
      transform: translateY(100vh) rotate(720deg) scale(0.5);
      opacity: 0;
    }
  }

  /* Ajustes espec√≠ficos para iPhone */
  @media screen and (max-width: 430px) and (max-height: 932px) {
    :root {
      --gap: 6px;
      --radius: 14px;
    }
    
    .board {
      --board-width: min(100vw - 30px, 380px);
      --board-height: min(100vh - 180px, 550px);
    }
  }

  /* iPhone SE y dispositivos peque√±os */
  @media screen and (max-width: 375px) {
    .controls {
      font-size: 11px;
    }
    
    button {
      padding: 7px 10px;
      font-size: 11px;
    }
    
    .pill {
      padding: 4px 8px;
      font-size: 11px;
    }
  }

  /* Prevenir zoom en iOS */
  input, select, textarea, button {
    font-size: 16px !important;
  }
</style>
</head>
<body>
  <header>
    <div class="header-top">
      <div class="title">
        <div class="logo">üåà</div>
        <span>Explota-Color</span>
      </div>
      <div class="stats">
        <div class="pill"><span class="pill-icon">üéØ</span><span id="target">0</span></div>
        <div class="pill"><span class="pill-icon">‚≠ê</span><span id="score">0</span></div>
        <div class="pill"><span class="pill-icon">üëÜ</span><span id="moves">0</span></div>
      </div>
    </div>
    <div class="controls">
      <select id="levelSel">
        <option value="baby">üë∂ Beb√©</option>
        <option value="easy">üê£ F√°cil</option>
        <option value="normal" selected>ü¶Ñ Normal</option>
        <option value="hard">üöÄ Dif√≠cil</option>
      </select>
      <select id="themeSel">
        <option value="frutas">üçì Frutas</option>
        <option value="animales">üêµ Animales</option>
        <option value="vehiculos">üöó Coches</option>
        <option value="caras">üòä Caras</option>
      </select>
      <button class="primary" id="newBtn">‚ú® Nuevo</button>
      <button id="soundBtn" class="warn">üîä</button>
      <button id="voiceBtn" class="success">üó£Ô∏è</button>
    </div>
  </header>

  <div class="board-wrap">
    <div id="board" class="board"></div>
  </div>

  <footer>
    <div class="hint">‚ú® Toca 2+ iguales ‚Ä¢ 5+ = pelota m√°gica ‚Ä¢ 2 pelotas = ¬°BOOM! üéÜ</div>
  </footer>

<script>
(function(){
  'use strict';
  
  // Configuraci√≥n
  const COLS = 6;
  const ROWS = 8;

  const EMOJI_THEMES = {
    frutas: [
      { emoji: 'üçì', ball: 'üî¥', name: 'fresa' },
      { emoji: 'ü´ê', ball: 'üîµ', name: 'ar√°ndano' },
      { emoji: 'ü•ù', ball: 'üü¢', name: 'kiwi' },
      { emoji: 'üçå', ball: 'üü°', name: 'pl√°tano' },
      { emoji: 'üçá', ball: 'üü£', name: 'uvas' }
    ],
    animales: [
      { emoji: 'üêµ', ball: 'üî¥', name: 'mono' },
      { emoji: 'üê∏', ball: 'üîµ', name: 'rana' },
      { emoji: 'ü¶Å', ball: 'üü¢', name: 'le√≥n' },
      { emoji: 'üê•', ball: 'üü°', name: 'pollito' },
      { emoji: 'üê∑', ball: 'üü£', name: 'cerdito' }
    ],
    vehiculos: [
      { emoji: 'üöó', ball: 'üî¥', name: 'auto' },
      { emoji: '‚úàÔ∏è', ball: 'üîµ', name: 'avi√≥n' },
      { emoji: 'üöÇ', ball: 'üü¢', name: 'tren' },
      { emoji: 'üö¢', ball: 'üü°', name: 'barco' },
      { emoji: 'üöÄ', ball: 'üü£', name: 'cohete' }
    ],
    caras: [
      { emoji: 'üòä', ball: 'üî¥', name: 'feliz' },
      { emoji: 'üòé', ball: 'üîµ', name: 'cool' },
      { emoji: 'ü§ó', ball: 'üü¢', name: 'abrazo' },
      { emoji: 'üòã', ball: 'üü°', name: 'rico' },
      { emoji: 'ü•≥', ball: 'üü£', name: 'fiesta' }
    ]
  };

  const LEVELS = {
    baby: { alpha: 0.05, breakMax: 12, target: 500, moves: 50 },
    easy: { alpha: 0.15, breakMax: 8, target: 2000, moves: 40 },
    normal: { alpha: 0.60, breakMax: 5, target: 4000, moves: 30 },
    hard: { alpha: 2.00, breakMax: 3, target: 6000, moves: 25 }
  };

  // Sistema de sonido simplificado
  class SoundSystem {
    constructor() {
      this.enabled = true;
      this.audioCtx = null;
      try {
        this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      } catch (e) {
        console.warn('Audio no disponible');
      }
    }

    playNote(freq, duration = 0.2) {
      if (!this.enabled || !this.audioCtx) return;
      try {
        const osc = this.audioCtx.createOscillator();
        const gain = this.audioCtx.createGain();
        osc.frequency.value = freq;
        osc.type = 'sine';
        gain.gain.setValueAtTime(0.1, this.audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, this.audioCtx.currentTime + duration);
        osc.connect(gain);
        gain.connect(this.audioCtx.destination);
        osc.start();
        osc.stop(this.audioCtx.currentTime + duration);
      } catch (e) {}
    }

    playPop() { this.playNote(800, 0.1); }
    playSuccess() { 
      [523, 659, 784].forEach((f, i) => {
        setTimeout(() => this.playNote(f, 0.15), i * 50);
      });
    }
    playSpecial() {
      [392, 523, 659, 784].forEach((f, i) => {
        setTimeout(() => this.playNote(f, 0.2), i * 60);
      });
    }
  }

  // Sistema de voz
  class VoiceSystem {
    constructor() {
      this.enabled = false;
      this.synth = window.speechSynthesis;
    }

    speak(text) {
      if (!this.enabled || !this.synth) return;
      try {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'es-ES';
        utterance.pitch = 1.3;
        utterance.rate = 0.9;
        utterance.volume = 0.6;
        this.synth.speak(utterance);
      } catch (e) {}
    }
  }

  // Estado del juego
  let state = {
    grid: [],
    score: 0,
    movesLeft: 30,
    target: 4000,
    level: 'normal',
    theme: 'frutas',
    animating: false
  };

  let currentTheme = EMOJI_THEMES.frutas;
  const soundSystem = new SoundSystem();
  const voiceSystem = new VoiceSystem();

  // Elementos DOM
  const boardEl = document.getElementById('board');
  const scoreEl = document.getElementById('score');
  const movesEl = document.getElementById('moves');
  const targetEl = document.getElementById('target');
  const newBtn = document.getElementById('newBtn');
  const levelSel = document.getElementById('levelSel');
  const themeSel = document.getElementById('themeSel');
  const soundBtn = document.getElementById('soundBtn');
  const voiceBtn = document.getElementById('voiceBtn');

  // FUNCI√ìN CR√çTICA: Renderizado con animaci√≥n de ca√≠da mejorada
  function render(animateChanges = false) {
    const oldTiles = new Map();
    
    // Guardar posiciones anteriores si vamos a animar
    if (animateChanges) {
      boardEl.querySelectorAll('.tile').forEach(tile => {
        const x = parseInt(tile.dataset.x);
        const y = parseInt(tile.dataset.y);
        oldTiles.set(`${x},${y}`, {
          element: tile,
          emoji: tile.textContent
        });
      });
    }
    
    boardEl.innerHTML = '';
    const fragment = document.createDocumentFragment();
    
    for (let y = 0; y < ROWS; y++) {
      for (let x = 0; x < COLS; x++) {
        const cell = state.grid[y][x];
        const tile = document.createElement('div');
        tile.className = 'tile';
        tile.dataset.x = x;
        tile.dataset.y = y;
        
        if (!cell) {
          tile.style.visibility = 'hidden';
        } else {
          tile.classList.add(`c${cell.color}`);
          
          if (cell.kind === 'ball') {
            tile.classList.add('special', 'ball');
            tile.textContent = currentTheme[cell.color].ball;
          } else {
            tile.textContent = currentTheme[cell.color].emoji;
          }
          
          // Animaci√≥n de ca√≠da si la ficha cay√≥
          if (animateChanges && cell.fallFrom !== undefined) {
            const distance = (cell.fallFrom - y) * 100;
            tile.style.setProperty('--fall-distance', `${distance}px`);
            tile.style.setProperty('--fall-duration', `${0.3 + (cell.fallFrom - y) * 0.05}s`);
            tile.style.setProperty('--fall-delay', `${x * 0.02}s`);
            tile.classList.add('falling');
            
            // Limpiar despu√©s de la animaci√≥n
            setTimeout(() => {
              tile.classList.remove('falling');
              tile.classList.add('bounce-land');
              setTimeout(() => tile.classList.remove('bounce-land'), 400);
            }, 300 + (cell.fallFrom - y) * 50 + x * 20);
            
            delete cell.fallFrom;
          }
          
          // Animaci√≥n para fichas nuevas (las que aparecen desde arriba)
          if (animateChanges && cell.isNew) {
            tile.style.setProperty('--drop-duration', `${0.4 + y * 0.03}s`);
            tile.style.setProperty('--drop-delay', `${(x * 0.03) + 0.1}s`);
            tile.classList.add('new-tile');
            
            setTimeout(() => {
              tile.classList.remove('new-tile');
            }, 500 + y * 30 + x * 30);
            
            delete cell.isNew;
          }
        }
        
        fragment.appendChild(tile);
      }
    }
    
    boardEl.appendChild(fragment);
  }

  // Click en ficha
  boardEl.addEventListener('click', (e) => {
    if (state.animating) return;
    
    const tile = e.target.closest('.tile');
    if (!tile) return;
    
    const x = parseInt(tile.dataset.x);
    const y = parseInt(tile.dataset.y);
    const cell = state.grid[y]?.[x];
    
    if (!cell) return;
    
    if (cell.kind === 'ball') {
      handleBallClick(x, y, cell.color);
    } else {
      handleNormalClick(x, y, cell.color);
    }
  });

  function handleNormalClick(x, y, color) {
    const group = findGroup(x, y, color);
    
    if (group.length < 2) {
      // Animar rebote
      const tile = boardEl.querySelector(`[data-x="${x}"][data-y="${y}"]`);
      if (tile) {
        tile.style.animation = 'bounce 0.3s';
        setTimeout(() => tile.style.animation = '', 300);
      }
      return;
    }
    
    state.animating = true;
    spendMove();
    
    // Crear pelota si el grupo es >= 5
    if (group.length >= 5) {
      // Animar explosi√≥n de todas excepto la central
      animateExplosion(group.filter(([gx, gy]) => !(gx === x && gy === y)));
      
      setTimeout(() => {
        // Eliminar todas excepto la central
        for (const [gx, gy] of group) {
          if (!(gx === x && gy === y)) {
            state.grid[gy][gx] = null;
          }
        }
        
        // Convertir la central en pelota
        state.grid[y][x] = { kind: 'ball', color: color };
        
        soundSystem.playSpecial();
        voiceSystem.speak('¬°Pelota m√°gica!');
        showToast('¬°Pelota m√°gica! ‚ú®');
        
        applyGravity();
        fillEmpty();
        render(true);
        
        setTimeout(() => {
          state.animating = false;
          checkGameState();
        }, 600);
      }, 300);
      
      addScore(100);
      return;
    }
    
    // Grupo normal
    animateExplosion(group);
    
    setTimeout(() => {
      for (const [gx, gy] of group) {
        state.grid[gy][gx] = null;
        spawnParticles(gx, gy, color);
      }
      
      soundSystem.playPop();
      
      if (group.length >= 3) {
        voiceSystem.speak('¬°Bien hecho!');
      }
      
      applyGravity();
      fillEmpty();
      render(true);
      
      setTimeout(() => {
        state.animating = false;
        checkGameState();
      }, 600);
    }, 300);
    
    addScore(group.length * 10);
  }

  function handleBallClick(x, y, color) {
    state.animating = true;
    spendMove();
    
    // Verificar si hay pelotas adyacentes
    const ballCluster = findBallCluster(x, y);
    
    if (ballCluster.length >= 2) {
      // Limpieza total
      animateScreenFlash();
      voiceSystem.speak('¬°Explosi√≥n total!');
      
      setTimeout(() => {
        // Eliminar todas las fichas normales
        for (let py = 0; py < ROWS; py++) {
          for (let px = 0; px < COLS; px++) {
            if (state.grid[py][px]) {
              if (state.grid[py][px].kind === 'normal') {
                spawnParticles(px, py, state.grid[py][px].color);
                state.grid[py][px] = null;
              } else if (ballCluster.some(([bx, by]) => bx === px && by === py)) {
                state.grid[py][px] = null;
              }
            }
          }
        }
        
        soundSystem.playSpecial();
        applyGravity();
        fillEmpty();
        render(true);
        
        setTimeout(() => {
          state.animating = false;
          checkGameState();
        }, 600);
      }, 400);
      
      addScore(500);
    } else {
      // Eliminar todas las fichas del color de la pelota
      const targets = [];
      for (let py = 0; py < ROWS; py++) {
        for (let px = 0; px < COLS; px++) {
          const cell = state.grid[py][px];
          if (cell && cell.kind === 'normal' && cell.color === color) {
            targets.push([px, py]);
          }
        }
      }
      
      animateColorExplosion(targets, color);
      
      setTimeout(() => {
        state.grid[y][x] = null; // Eliminar la pelota
        for (const [tx, ty] of targets) {
          state.grid[ty][tx] = null;
          spawnParticles(tx, ty, color);
        }
        
        soundSystem.playSuccess();
        voiceSystem.speak('¬°Explosi√≥n de color!');
        
        applyGravity();
        fillEmpty();
        render(true);
        
        setTimeout(() => {
          state.animating = false;
          checkGameState();
        }, 600);
      }, 400);
      
      addScore(targets.length * 20);
    }
  }

  // FUNCI√ìN CR√çTICA: Aplicar gravedad con seguimiento de ca√≠das
  function applyGravity() {
    for (let x = 0; x < COLS; x++) {
      const column = [];
      
      // Recoger fichas no nulas de la columna
      for (let y = 0; y < ROWS; y++) {
        if (state.grid[y][x]) {
          column.push({
            cell: state.grid[y][x],
            originalY: y
          });
        }
      }
      
      // Limpiar columna
      for (let y = 0; y < ROWS; y++) {
        state.grid[y][x] = null;
      }
      
      // Colocar fichas desde abajo con informaci√≥n de ca√≠da
      let writePos = ROWS - 1;
      for (let i = column.length - 1; i >= 0; i--) {
        const item = column[i];
        state.grid[writePos][x] = item.cell;
        
        // Marcar desde d√≥nde cay√≥ si se movi√≥
        if (writePos > item.originalY) {
          state.grid[writePos][x].fallFrom = item.originalY;
        }
        
        writePos--;
      }
    }
  }

  // FUNCI√ìN CR√çTICA: Rellenar espacios vac√≠os con fichas nuevas
  function fillEmpty() {
    for (let y = 0; y < ROWS; y++) {
      for (let x = 0; x < COLS; x++) {
        if (!state.grid[y][x]) {
          state.grid[y][x] = {
            kind: 'normal',
            color: Math.floor(Math.random() * 5),
            isNew: true // Marcar como nueva para animar
          };
        }
      }
    }
  }

  // Encontrar grupo de fichas conectadas
  function findGroup(startX, startY, color) {
    const visited = new Set();
    const stack = [[startX, startY]];
    const group = [];
    
    while (stack.length > 0) {
      const [x, y] = stack.pop();
      const key = `${x},${y}`;
      
      if (visited.has(key)) continue;
      visited.add(key);
      
      const cell = state.grid[y]?.[x];
      if (!cell || cell.kind !== 'normal' || cell.color !== color) continue;
      
      group.push([x, y]);
      
      // Agregar vecinos
      if (x > 0) stack.push([x - 1, y]);
      if (x < COLS - 1) stack.push([x + 1, y]);
      if (y > 0) stack.push([x, y - 1]);
      if (y < ROWS - 1) stack.push([x, y + 1]);
    }
    
    return group;
  }

  // Encontrar cluster de pelotas
  function findBallCluster(startX, startY) {
    const visited = new Set();
    const stack = [[startX, startY]];
    const cluster = [];
    
    while (stack.length > 0) {
      const [x, y] = stack.pop();
      const key = `${x},${y}`;
      
      if (visited.has(key)) continue;
      visited.add(key);
      
      const cell = state.grid[y]?.[x];
      if (!cell || cell.kind !== 'ball') continue;
      
      cluster.push([x, y]);
      
      // Agregar vecinos
      if (x > 0) stack.push([x - 1, y]);
      if (x < COLS - 1) stack.push([x + 1, y]);
      if (y > 0) stack.push([x, y - 1]);
      if (y < ROWS - 1) stack.push([x, y + 1]);
    }
    
    return cluster;
  }

  // Animaciones
  function animateExplosion(cells) {
    for (const [x, y] of cells) {
      const tile = boardEl.querySelector(`[data-x="${x}"][data-y="${y}"]`);
      if (tile) {
        tile.classList.add('exploding');
      }
    }
  }

  function animateColorExplosion(cells, color) {
    const colors = ['#ff4d4f', '#3b82f6', '#22c55e', '#f59e0b', '#a855f7'];
    const colorVar = colors[color];
    
    for (const [x, y] of cells) {
      const tile = boardEl.querySelector(`[data-x="${x}"][data-y="${y}"]`);
      if (tile) {
        tile.style.boxShadow = `0 0 20px ${colorVar}`;
        tile.classList.add('exploding');
      }
    }
  }

  function animateScreenFlash() {
    document.body.style.animation = 'flash 0.3s';
    setTimeout(() => document.body.style.animation = '', 300);
  }

  // Part√≠culas
  function spawnParticles(x, y, color) {
    const tile = boardEl.querySelector(`[data-x="${x}"][data-y="${y}"]`);
    if (!tile) return;
    
    const rect = tile.getBoundingClientRect();
    const colors = ['#ff4d4f', '#3b82f6', '#22c55e', '#f59e0b', '#a855f7'];
    
    for (let i = 0; i < 6; i++) {
      const particle = document.createElement('div');
      particle.className = 'piece';
      particle.style.left = rect.left + rect.width / 2 + 'px';
      particle.style.top = rect.top + rect.height / 2 + 'px';
      particle.style.background = colors[color];
      
      const angle = (Math.PI * 2 * i) / 6;
      const distance = 50 + Math.random() * 50;
      particle.style.setProperty('--dx', Math.cos(angle) * distance + 'px');
      particle.style.setProperty('--dy', Math.sin(angle) * distance + 'px');
      
      document.body.appendChild(particle);
      setTimeout(() => particle.remove(), 800);
    }
  }

  // UI
  function showToast(message) {
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 1500);
  }

  function addScore(points) {
    state.score += points;
    updateUI();
    showToast(`+${points} ‚≠ê`);
  }

  function spendMove() {
    if (state.movesLeft > 0) {
      state.movesLeft--;
      updateUI();
    }
  }

  function updateUI() {
    scoreEl.textContent = state.score;
    movesEl.textContent = state.movesLeft;
    targetEl.textContent = state.target;
  }

  function checkGameState() {
    if (state.score >= state.target) {
      showWin();
    } else if (state.movesLeft === 0) {
      showGameOver();
    }
  }

  function showWin() {
    soundSystem.playSpecial();
    voiceSystem.speak('¬°Ganaste! ¬°Eres incre√≠ble!');
    
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
      <div class="modal-card">
        <div class="trophy">üèÜ</div>
        <h2>¬°VICTORIA!</h2>
        <p>¬°Conseguiste ${state.score} puntos!</p>
        <div style="margin-top: 16px; display: flex; gap: 10px;">
          <button onclick="location.reload()" class="primary" style="flex: 1; padding: 10px;">
            üéÆ Jugar de nuevo
          </button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  }

  function showGameOver() {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
      <div class="modal-card">
        <div class="trophy">üò¢</div>
        <h2>¬°Se acab√≥!</h2>
        <p>Conseguiste ${state.score} puntos</p>
        <div style="margin-top: 16px; display: flex; gap: 10px;">
          <button onclick="location.reload()" class="primary" style="flex: 1; padding: 10px;">
            üéÆ Intentar de nuevo
          </button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  }

  // Inicializaci√≥n
  function init() {
    state.level = levelSel.value;
    state.theme = themeSel.value;
    currentTheme = EMOJI_THEMES[state.theme];
    
    const config = LEVELS[state.level];
    state.target = config.target;
    state.movesLeft = config.moves;
    state.score = 0;
    state.animating = false;
    
    // Generar tablero
    state.grid = [];
    for (let y = 0; y < ROWS; y++) {
      state.grid[y] = [];
      for (let x = 0; x < COLS; x++) {
        state.grid[y][x] = {
          kind: 'normal',
          color: Math.floor(Math.random() * 5)
        };
      }
    }
    
    render(false);
    updateUI();
  }

  // Event listeners
  newBtn.addEventListener('click', () => {
    init();
    showToast('¬°Nuevo juego! üéÆ');
  });

  levelSel.addEventListener('change', init);
  themeSel.addEventListener('change', () => {
    currentTheme = EMOJI_THEMES[themeSel.value];
    render(false);
  });

  soundBtn.addEventListener('click', () => {
    soundSystem.enabled = !soundSystem.enabled;
    soundBtn.textContent = soundSystem.enabled ? 'üîä' : 'üîá';
  });

  voiceBtn.addEventListener('click', () => {
    voiceSystem.enabled = !voiceSystem.enabled;
    voiceBtn.textContent = voiceSystem.enabled ? 'üó£Ô∏è' : 'üîï';
  });

  // Iniciar juego
  init();
  showToast('¬°Bienvenido! üåà');

  // ====== AUTOTESTS M√çNIMOS (no intrusivos) ======
  (function selfTests(){
    try {
      console.assert(typeof findGroup === 'function', 'findGroup debe existir');
      console.assert(typeof render === 'function', 'render debe existir');
      // Forzar un grupo conocido
      state.grid = Array.from({length: ROWS}, (_, y)=>Array.from({length: COLS}, (_, x)=>({kind:'normal', color: (x<2&&y<1)?1:0})));
      const g = findGroup(0,0, state.grid[0][0].color);
      console.assert(Array.isArray(g) && g.length >= 2, 'findGroup devuelve al menos 2');
      // Simular pelota y limpieza de color
      state.grid[0][0] = {kind:'ball', color:0};
      const cluster = findBallCluster(0,0);
      console.assert(cluster.length === 1, 'findBallCluster detecta 1 pelota');
    } catch (e) { console.warn('SelfTests aviso:', e); }
  })();

})();
</script>
</body>
</html>
